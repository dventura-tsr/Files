<html>
<head>
<script src="https://cdn.prod.us.five9.net/static/alpha/chat/wrapper/index.js"></script>
  <style>
.root .pn-msg-input__wrapper.pn-msg-input__wrapper {border-radius: 6px;}
.f9ChatOpened {
    min-height: 560px;
    position: fixed !important;
    right: 300px !important;
    bottom: 3px !important;
    box-shadow: 0px 4px 10px rgba(0, 0, 0, 0.25) !important;
    border-radius: 25px !important;
}
  </style>
</head>

<body>
<script>
  F9.Chat.Wrapper.init({
    cdn: 'alpha-us',
    useBusinessHours: false,
    languages: {"enabled":false,"backgroundColor":"#65758e"},
    l10n: {"en":{"messenger":{"customText":{}},"systemMessages":{"transferredToParticipant":"The chat has been transferred to {name}.","transferredToGroup":"That chat has been transferred to group {group}."}, "captureFields":[{"k":"Question","l":""}]}},
prepopulatedFields: [{"k":"campaign","v":"Dan_Chat"},{"k":"name","v":""},{"k":"email","v":""},{"k":"memberId","v":"00000000000"}],
messenger: {"integrationId":"6227e8d6b2944300f32d37a9","soundNotificationEnabled":true,"transcriptPrintingEnabled":true,"menuItems":{"imageUpload":true,"fileUpload":true,"shareLocation":true},"embedded":false,"setViewportScale":false,"browserStorage":"localStorage","hideWidgetAfterBusinessHours":false,"openLinkInSameTab":false,"scheduleCallback":{"isCallbackEnabled":false,"requestCallbackList":"","customConfirmationMessage":"We will call you as soon as we can at [PHONE]","web2CampaignAPIHost":""},"fixedHeader":false,"displayStyle":"button","customColors":{"brandColor":"65758e","conversationColor":"4B5DFF","actionColor":"4B5DFF"},"carouselType":"default","customCssUrl":"https://dventura-tsr.github.io/Files/advance-chat-test.css"},
    clearMessagesTimeout: 3
  });
  </script>


<script>
/**
 * Robust "end chat on tab close" helper
 * - Tries to click the End Chat button (best-effort)
 * - Sends a small reliable request using navigator.sendBeacon or fetch(..., { keepalive: true })
 * - Works on pagehide, visibilitychange and beforeunload (preference: pagehide/sendBeacon)
 */

(function () {
  const ENDPOINT = '/api/endChat'; // <-- change to your server endpoint
  const SELECTOR = 'button[aria-label="End Chat"]'; // <-- change selector if needed
  let alreadySent = false;
  const getSessionInfo = () => ({
    sessionId: window.chatSessionId || null,
    ts: new Date().toISOString(),
    reason: 'tab_closed'
  });

  function doProgrammaticClick() {
    try {
      const btn = document.querySelector(SELECTOR);
      if (!btn) {
        console.info('endChat: button not found with selector', SELECTOR);
        return false;
      }
      // Some frameworks block non-user events by checking event.isTrusted.
      // A programmatic click is isTrusted === false; still try it as a best-effort.
      btn.click();
      console.info('endChat: clicked End Chat button');
      return true;
    } catch (err) {
      console.warn('endChat: click failed', err);
      return false;
    }
  }

  function sendBeaconFallback(payload) {
    try {
      if (navigator.sendBeacon) {
        const blob = new Blob([JSON.stringify(payload)], { type: 'application/json' });
        const ok = navigator.sendBeacon(ENDPOINT, blob);
        console.info('endChat: sendBeacon sent?', ok);
        return ok;
      }
    } catch (e) {
      console.warn('endChat: sendBeacon error', e);
    }
    return false;
  }

  function fetchKeepalive(payload) {
    try {
      // keepalive works only for small payloads and is the next best option
      fetch(ENDPOINT, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload),
        keepalive: true
      }).then(() => console.info('endChat: fetch keepalive resolved'))
        .catch(e => console.warn('endChat: fetch keepalive failed', e));
      return true;
    } catch (e) {
      console.warn('endChat: fetch keepalive exception', e);
      return false;
    }
  }

  function endChatAction() {
    if (alreadySent) return;
    alreadySent = true;

    const payload = getSessionInfo();

    // 1) Try programmatic click (UI-level). This may fail or be ignored during unload.
    doProgrammaticClick();

    // 2) Try sendBeacon (most reliable during unload/pagehide)
    if (sendBeaconFallback(payload)) return;

    // 3) Fallback to fetch with keepalive (best-effort)
    if (fetchKeepalive(payload)) return;

    // 4) As last resort, try a synchronous XHR (deprecated/blocked in many browsers).
    try {
      const xhr = new XMLHttpRequest();
      xhr.open('POST', ENDPOINT, false); // synchronous
      xhr.setRequestHeader('Content-Type', 'application/json');
      xhr.send(JSON.stringify(payload));
      console.info('endChat: sync XHR sent (last-resort)');
    } catch (e) {
      console.warn('endChat: sync XHR failed (likely blocked)', e);
    }
  }

  // Attach multiple events for broader browser support:
  window.addEventListener('pagehide', endChatAction); // preferred for unload-like events
  window.addEventListener('visibilitychange', function () {
    if (document.visibilityState === 'hidden') {
      endChatAction();
    }
  });
  // beforeunload can be useful, but asynchronous work is often cancelled; still attach it.
  window.addEventListener('beforeunload', endChatAction);

  // Optional: if you have a WebSocket used for chat, try to close cleanly:
  window.addEventListener('pagehide', function () {
    try {
      if (window.chatWebSocket && window.chatWebSocket.readyState === WebSocket.OPEN) {
        // send end intent if your server understands it
        window.chatWebSocket.send(JSON.stringify({ type: 'endChat', ...(getSessionInfo()) }));
        window.chatWebSocket.close(1000, 'tab closed');
      }
    } catch (e) {
      console.warn('endChat: ws close failed', e);
    }
  });

  // Expose helper for manual testing:
  window._endChatAction = endChatAction;

})();
</script>





  <form id="contactForm">
  <!-- your form fields here -->

  <button type="submit">Start Chat</button>
</form>

<!-- your real Begin Chat button -->
<button type="submit" data-testid="submitButton" aria-label="Begin Chat" 
  button-name="Begin Chat" customcolor="#4B5DFF" 
  class="btn sc-iBYQkv SGtFP btn btn-sm btn-primary btn-outline rounded-2xl text-size2 font-weight5 py-1 px-2 min-w-[90px]">
  Begin Chat
</button>

<script>
  document.getElementById("contactForm").addEventListener("submit", function(e) {
    e.preventDefault(); // prevent actual form submission
    document.querySelector('button[aria-label="Begin Chat"]').click();
  });
</script>

  

  
</body>
</html>




































